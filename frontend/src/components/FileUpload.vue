<template>
  <v-container>
    <v-form ref="form" @submit.prevent="submitFile" class="scan-form">
      <v-row>
        <v-col cols="12" md="6">
          <v-file-input
              v-model="files"
              label="Choose a file..."
              prepend-icon="mdi-paperclip"
              accept=".exe,.dll,.zip"
              :disabled="fileUrl.length > 0"
              show-size
              color="primary"
          ></v-file-input>
          <v-text-field
              label="File URL"
              v-model="fileUrl"
              :disabled="files"
              placeholder="Enter the URL of the file"
              color="primary"
          ></v-text-field>
          <v-text-field
              label="Zip Password"
              v-model="zipPassword"
              :disabled="!isZipFile"
              placeholder="Enter the password for the zip file"
              color="primary"
          ></v-text-field>
        </v-col>
        <v-col cols="12" md="6">
          <v-switch
              v-model="forceRescan"
              label="Force Rescan"
              color="primary"
          ></v-switch>
          <v-switch
              v-model="useExternalTools"
              label="Use External Tools Feedback"
              color="primary"
          ></v-switch>
          <v-select
              v-model="knownStatus"
              :items="statusOptions"
              label="Known Status"
              item-value="value"
              item-title="text"
              persistent-hint
              clearable=true
              color="primary"
          ></v-select>
        </v-col>
      </v-row>
      <v-row class="text-center">
        <v-col>
          <v-btn type="submit" color="primary" class="mr-2">
            <v-progress-circular
                v-if="isLoading"
                indeterminate
                size="20"
            ></v-progress-circular>
            Scan
          </v-btn>
          <v-btn color="grey" @click="resetForm">Reset</v-btn>
        </v-col>
      </v-row>

      <!-- Alert for Error Messages -->
      <v-alert v-if="errorMessage" type="error" class="mt-4" dense>
        {{ errorMessage }}
      </v-alert>


      <!-- Scan Result Card -->
      <v-card
          v-if="scanResult"
          :class="['mt-4', 'outlined', overallScanStatus]"
      >
        <v-card-title>
          <v-icon left>
            {{ determineStatusIcon(overallScanStatus) }}
          </v-icon>
          Scan Details
        </v-card-title>
        <v-card-text>
          <v-row>
            <v-col cols="12" md="6">
              <v-list dense>
                <!-- MD5 File Hash and Scanned At -->
                <v-list-item>
                  <v-list-item-icon>
                    <v-icon>mdi-file</v-icon>
                  </v-list-item-icon>
                  <v-list-item-content>
                    <v-list-item-title>MD5 File Hash</v-list-item-title>
                    <v-list-item-subtitle>{{ scanResult.md5_file_hash }}</v-list-item-subtitle>
                  </v-list-item-content>
                </v-list-item>
                <v-list-item>
                  <v-list-item-icon>
                    <v-icon>mdi-calendar-clock</v-icon>
                  </v-list-item-icon>
                  <v-list-item-content>
                    <v-list-item-title>Scanned At</v-list-item-title>
                    <v-list-item-subtitle>{{ formattedScanDate }}</v-list-item-subtitle>
                  </v-list-item-content>
                </v-list-item>
              </v-list>
            </v-col>
            <v-col cols="12" md="6">
              <v-list dense>
                <!-- Scan Results -->
                <v-list-item>
                  <v-list-item-icon>
                    <v-icon>mdi-brain</v-icon>
                  </v-list-item-icon>
                  <v-list-item-content>
                    <v-list-item-title>Deep Learning Model Prediction</v-list-item-title>
                    <v-list-item-subtitle>{{ scanResult.deep_learning_result ? 'Malware' : 'Benign' }}</v-list-item-subtitle>
                  </v-list-item-content>
                </v-list-item>
                <v-list-item>
                  <v-list-item-icon>
                    <v-icon>mdi-pine-tree</v-icon>
                  </v-list-item-icon>
                  <v-list-item-content>
                    <v-list-item-title>Random Forest Model Prediction</v-list-item-title>
                    <v-list-item-subtitle>{{ scanResult.random_forest_result ? 'Malware' : 'Benign' }}</v-list-item-subtitle>
                  </v-list-item-content>
                </v-list-item>
                <v-list-item>
                  <v-list-item-icon>
                    <v-icon>mdi-information</v-icon>
                  </v-list-item-icon>
                  <v-list-item-content>
                    <v-list-item-title>Known Status</v-list-item-title>
                    <v-list-item-subtitle>{{ scanResult.known_status === null ? 'Unknown' : (scanResult.known_status ? 'Malware' : 'Benign') }}</v-list-item-subtitle>
                  </v-list-item-content>
                </v-list-item>
              </v-list>
            </v-col>
          </v-row>
        </v-card-text>
      </v-card>
    </v-form>
  </v-container>
</template>

<script>
import {scanFile} from '@/services/apiService';
import moment from 'moment';

export default {
  name: 'FileUpload',
  data() {
    return {
      files: null,
      knownStatus: null,
      useExternalTools: false,
      forceRescan: false,
      scanResult: null,
      errorMessage: null,
      statusOptions: [
        {text: 'Unknown', value: null},
        {text: 'Benign', value: 0},
        {text: 'Malware', value: 1},
      ],
      scanResultType: '',
      fileUrl: '',
      zipPassword: '',
      isLoading: false,
    };
  },
  computed: {
    overallScanStatus() {
      if (this.scanResult) {
        const {deep_learning_result, random_forest_result} = this.scanResult;
        if (deep_learning_result === 1 && random_forest_result === 1) {
          return 'status-danger';
        } else if (deep_learning_result === 1 || random_forest_result === 1) {
          return 'status-warning';
        } else {
          return 'status-safe';
        }
      } else if (this.scanResultType === 'error') {
        return 'status-error';
      }
      return 'status-unknown';
    },
    formattedScanDate() {
      if (this.scanResult && this.scanResult.scanned_at) {
        return moment(this.scanResult.scanned_at).format('MMMM Do YYYY, h:mm:ss a');
      }
      return '';
    },
    isZipFile() {
      if (this.files) {
        return this.files[0].name.endsWith('.zip');
      } else if (this.fileUrl) {
        return this.fileUrl.endsWith('.zip');
      }
      return false;
    },
  },
  methods: {
    async submitFile() {
      this.errorMessage = null;
      this.scanResult = null;

      // Check if either a file or URL is provided
      if (!this.files && !this.fileUrl) {
        this.errorMessage = 'Please select a file or enter a file URL.';
        return;
      }
      this.isLoading = true;

      try {
        // Call the API with both file and URL parameters
        this.scanResult = await scanFile(
            this.files ? this.files[0] : null,
            this.fileUrl,
            this.zipPassword,
            this.knownStatus,
            this.useExternalTools,
            this.forceRescan
        );
        this.scanResultType = 'success';
      } catch (error) {
        this.scanResultType = 'error';
        if (error.response && error.response.data && error.response.data.detail) {
          this.errorMessage = error.response.data.detail;
        } else {
          this.errorMessage = 'Failed to scan the file. Please try again later.';
        }
        this.scanResult = null;
      }
      this.isLoading = false;
    },
    resetForm() {
      // Reset all form fields
      this.files = null;
      this.fileUrl = '';
      this.zipPassword = '';
      this.knownStatus = null;
      this.useExternalTools = false;
      this.forceRescan = false;
    },

    determineStatusIcon(status) {
      const statusIcons = {
        'status-danger': 'mdi-alert',
        'status-warning': 'mdi-alert',
        'status-safe': 'mdi-check-circle',
        'status-unknown': 'mdi-help-circle',
        'status-error': 'mdi-alert-circle',
      };
      return statusIcons[status];
    },
  },
};
</script>
<style>
.scan-form /deep/ .v-text-field__slot,
.scan-form /deep/ .v-select__slot {
  padding-top: 0;
}

.status-danger {
  background-color: #ae2125;
  border-color: #F44336;
}

.status-warning {
  background-color: #d5973b;
  border-color: #FF9800; /* Orange */
}

.status-safe {
  background-color: #63d766; /* Light green */
  border-color: #4CAF50; /* Green */
}

.status-unknown {
  background-color: #E0E0E0; /* Light grey */
  border-color: #9E9E9E; /* Grey */
}

/* ... other styles ... */
</style>