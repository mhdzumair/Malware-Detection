<template>
  <v-container>
    <h1>Scans History</h1>
    <v-data-table-server
        :headers="headers"
        :items-length="totalScans"
        :items="scans"
        :loading="loading"
        :items-per-page="10"
        @update:options="fetchScans"
        class="elevation-1"
        no-data-text="No scan data available"
        no-results-text="No matching records found"
        density="compact"
    >
      <template v-slot:[`item.deep_learning_result`]="{ item }">
        <v-chip :color="item.deep_learning_result ? 'red' : 'green'">
          {{ item.deep_learning_result ? 'Malware' : 'Benign' }}
        </v-chip>
      </template>
      <template v-slot:[`item.random_forest_result`]="{ item }">
        <v-chip :color="item.random_forest_result ? 'red' : 'green'">
          {{ item.random_forest_result ? 'Malware' : 'Benign' }}
        </v-chip>
      </template>
      <template v-slot:[`item.scanned_at`]="{ item }">
        {{ formatScanDate(item.scanned_at) }}
      </template>
      <template v-slot:[`item.known_status`]="{ item }">
        <v-chip :color="item.known_status === null ? 'grey' : (item.known_status ? 'red' : 'green')">
          {{ item.known_status === null ? 'Unknown' : (item.known_status ? 'Malware' : 'Benign') }}
        </v-chip>
      </template>
    </v-data-table-server>
    <v-alert v-if="errorMessage" type="error" class="mt-4">
      {{ errorMessage }}
    </v-alert>
  </v-container>
</template>

<script>
import {getScans} from '@/services/apiService';
import moment from 'moment';

export default {
  name: 'ScanHistory',
  data() {
    return {
      scans: [],
      loading: false,
      errorMessage: '',
      totalScans: 0,
      options: {},
      headers: [
        {title: 'MD5 Hash', value: 'md5_file_hash'},
        {title: 'Deep Learning Result', value: 'deep_learning_result'},
        {title: 'Random Forest Result', value: 'random_forest_result'},
        {title: 'Scanned At', value: 'scanned_at'},
        {title: 'Known Status', value: 'known_status'}
      ],
    };
  },
  methods: {
    async fetchScans(options) {
      this.loading = true;
      this.errorMessage = '';

      try {
        const response = await getScans(options);
        this.scans = response.items;
        this.totalScans = response.total;
      } catch (error) {
        console.error('Error fetching scans:', error);
        this.errorMessage = 'Failed to load scan history.';
      } finally {
        this.loading = false;
      }
    },
    formatScanDate(date) {
      return moment(date).format('MMMM Do YYYY, h:mm:ss a');
    }
  },
  created() {
    this.fetchScans(this.options);
  }
};
</script>

<style>
/* Custom styles for the data table */
.v-chip {
  color: white;
}
</style>
