import logging
import time
from typing import Optional

import vt


async def get_virus_total_report(
    file_data: bytes,
    file_hash: str,
    api_key: str,
) -> Optional[dict]:
    """
    Gets the VirusTotal report for a file
    :param file_data: the file data
    :param file_hash: the sha256 or md5 hash of the file
    :param api_key: the VirusTotal API key
    :return: the VirusTotal report
    """

    client = vt.Client(api_key)
    file_scan = None
    try:
        file_scan = await client.get_object_async(f"/files/{file_hash}")

    except vt.APIError as e:
        if e.code == "NotFoundError":
            file_scan = await client.scan_file_async(file_data)

            while True:
                file_scan = await client.get_object_async("/analyses/{}", file_scan.id)
                logging.info(file_scan.status)
                if file_scan.status == "completed":
                    break
                time.sleep(5)

    await client.close_async()

    if file_scan.last_analysis_stats.get("malicious") > 0:
        logging.info("Malware detected in file.")
    else:
        logging.info("File is clean.")

    return file_scan.last_analysis_stats
